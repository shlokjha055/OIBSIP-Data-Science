import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.metrics import r2_score, mean_absolute_error, mean_squared_error

from sklearn.linear_model import LinearRegression
from sklearn.ensemble import RandomForestRegressor

import warnings
warnings.filterwarnings('ignore')


df = pd.read_csv(r'C:\Users\shlok\Python\Task 3\Car_data.csv')

print("Dataset Shape:", df.shape)
print(df.head())


X = df.drop('Selling_Price', axis=1)
y = np.log1p(df['Selling_Price'])   


X['Car_Age'] = 2026 - X['Year']
X.drop('Year', axis=1, inplace=True)


numeric_features = X.select_dtypes(include=['int64', 'float64']).columns
categorical_features = X.select_dtypes(include=['object']).columns


numeric_pipeline = Pipeline([
    ('scaler', StandardScaler())
])

categorical_pipeline = Pipeline([
    ('onehot', OneHotEncoder(drop='first', handle_unknown='ignore'))
])

preprocessor = ColumnTransformer([
    ('num', numeric_pipeline, numeric_features),
    ('cat', categorical_pipeline, categorical_features)
])


X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)


models = {
    "Linear Regression": LinearRegression(),
    "Random Forest": RandomForestRegressor(
        n_estimators=200,
        random_state=42,
        n_jobs=-1
    )
}


for name, model in models.items():
    pipeline = Pipeline([
        ('preprocessing', preprocessor),
        ('model', model)
    ])
    
    pipeline.fit(X_train, y_train)
    predictions = pipeline.predict(X_test)
    
    r2 = r2_score(y_test, predictions)
    rmse = np.sqrt(mean_squared_error(
        np.expm1(y_test),
        np.expm1(predictions)
    ))
    
    print(f"\n{name}")
    print(f"R² Score: {r2:.4f}")
    print(f"RMSE: ₹{rmse:,.0f}")


rf_pipeline = Pipeline([
    ('preprocessing', preprocessor),
    ('model', RandomForestRegressor(random_state=42))
])

param_grid = {
    'model__n_estimators': [200, 300],
    'model__max_depth': [15, 25, None],
    'model__min_samples_split': [2, 5],
    'model__min_samples_leaf': [1, 2]
}

grid = GridSearchCV(
    rf_pipeline,
    param_grid,
    cv=5,
    scoring='r2',
    n_jobs=-1
)

grid.fit(X_train, y_train)

best_model = grid.best_estimator_
best_predictions = best_model.predict(X_test)

best_r2 = r2_score(y_test, best_predictions)
best_rmse = np.sqrt(mean_squared_error(
    np.expm1(y_test),
    np.expm1(best_predictions)
))

print("\nBest Random Forest Model")
print("Best Parameters:", grid.best_params_)
print(f"R² Score: {best_r2:.4f}")
print(f"RMSE: ₹{best_rmse:,.0f}")

print("\n================ RANDOM CAR PRICE PREDICTIONS ================\n")


random_cars = X.sample(n=5, random_state=101)


random_log_preds = best_model.predict(random_cars)


random_price_preds = np.expm1(random_log_preds)


random_output = random_cars.copy()
random_output['Predicted_Price (₹)'] = random_price_preds.round(0)


print(random_output[
    ['Present_Price', 'Driven_kms', 'Fuel_Type',
     'Selling_type', 'Transmission', 'Owner',
     'Car_Age', 'Predicted_Price (₹)']
])
